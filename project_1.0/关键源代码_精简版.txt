# 广西自动化学会会员管理系统 - 关键源代码（精简版）
## 一、核心配置与类型定义
### 1.1 Supabase配置 (supabase.ts)
```typescript
// Supabase客户端配置，连接数据库和认证服务
import { createClient } from '@supabase/supabase-js';
// 从环境变量获取配置
const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
// 创建并导出客户端实例
export const supabase = createClient(supabaseUrl, supabaseAnonKey);
```

### 1.2 类型定义 (types/index.ts)
```typescript
// 用户配置文件接口
export interface Profile {
  id: string;
  email: string;
  full_name: string;
  role: 'member' | 'admin';
  membership_level?: string; // 会员等级
  membership_status?: 'active' | 'inactive' | 'pending'; // 会员状态
  membership_duration_days?: number; // 剩余天数
  payment_status?: string; // 缴费状态
  join_date?: string; // 加入日期
  phone?: string;
  institution?: string; // 单位/学校
  created_at: string;
}
// 会员申请接口
export interface Application {
  id: string;
  user_id: string;
  full_name: string;
  content: string; // 申请内容
  status: 'pending' | 'approved' | 'rejected'; // 审核状态
  created_at: string;
}
// 消息接口
export interface AppMessage {
  id: string;
  sender_id: string;
  receiver_id: string;
  subject: string;
  content: string;
  message_type: 'text' | 'event_application'; // 消息类型
  is_read: boolean; // 已读状态
  created_at: string;
}
```

## 二、认证与授权
### 2.1 认证上下文 (AuthContext.tsx)
```typescript
import React, { createContext, useContext, useState, useEffect } from 'react';
import { supabase } from '../lib/supabase';
import type { Session, User } from '@supabase/supabase-js';
import type { Profile } from '../types';

// 认证上下文类型
interface AuthContextType {
  user: User | null;
  session: Session | null;
  profile: Profile | null;
  loading: boolean;
  signIn: (email: string, password: string) => Promise<void>;
  signUp: (email: string, password: string, fullName: string) => Promise<void>;
  signOut: () => Promise<void>;
}

// 创建上下文
const AuthContext = createContext<AuthContextType | undefined>(undefined);

// 认证提供者组件
export const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [user, setUser] = useState<User | null>(null);
  const [session, setSession] = useState<Session | null>(null);
  const [profile, setProfile] = useState<Profile | null>(null);
  const [loading, setLoading] = useState(true);

  // 初始化认证状态
  useEffect(() => {
    // 获取当前会话
    const { data: { session } } = supabase.auth.getSession();
    setSession(session);
    setUser(session?.user ?? null);
    // 监听认证状态变化
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      async (_event, session) => {
        setSession(session);
        setUser(session?.user ?? null);
        // 获取用户配置文件
        if (session?.user) {
          const { data } = await supabase.from('profiles').select('*').eq('id', session.user.id).single();
          setProfile(data || null);
        } else {
          setProfile(null);
        }
        setLoading(false);
      }
    );
    return () => subscription.unsubscribe();
  }, []);

  // 登录方法
  const signIn = async (email: string, password: string) => {
    await supabase.auth.signInWithPassword({ email, password });
  };

  // 注册方法
  const signUp = async (email: string, password: string, fullName: string) => {
    await supabase.auth.signUp({ email, password, options: { data: { full_name: fullName } } });
  };

  // 退出登录
  const signOut = async () => {
    await supabase.auth.signOut();
  };

  // 提供上下文值
  const value = { user, session, profile, loading, signIn, signUp, signOut };
  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
};

// 自定义Hook，获取认证上下文
export const useAuth = () => {
  const context = useContext(AuthContext);
  if (!context) throw new Error('useAuth必须在AuthProvider内使用');
  return context;
};
```

### 2.2 路由保护组件 (ProtectedRoute.tsx)
```typescript
import React from 'react';
import { Navigate, Outlet, useLocation } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';

// 路由保护组件，限制角色访问
interface ProtectedRouteProps {
  role?: 'member' | 'admin';
}

const ProtectedRoute: React.FC<ProtectedRouteProps> = ({ role }) => {
  const { user, profile, loading } = useAuth();
  const location = useLocation();
  // 加载状态
  if (loading) return <div className="flex justify-center items-center h-screen">加载中...</div>;
  // 未登录重定向到登录页
  if (!user) return <Navigate to="/login" state={{ from: location }} replace />;
  // 角色不符重定向到对应仪表盘
  if (role && profile?.role !== role) {
    return profile?.role === 'admin' ? <Navigate to="/admin" replace /> : <Navigate to="/member" replace />;
  }
  // 允许访问，渲染子路由
  return <Outlet />;
};

export default ProtectedRoute;
```

## 三、应用路由与入口
### 3.1 应用路由 (App.tsx)
```typescript
// 导入React Router核心组件
import { Routes, Route } from 'react-router-dom';
// 导入页面组件
import Login from './pages/Login';
import Register from './pages/Register';
import MemberDashboard from './pages/MemberDashboard';
import AdminDashboard from './pages/AdminDashboard';
import ProtectedRoute from './components/ProtectedRoute';

// 应用根组件，定义路由
function App() {
  return (
    <div className="min-h-screen bg-gray-50">
      <Routes>
        {/* 公开路由 */}
        <Route path="/login" element={<Login />} />
        <Route path="/register" element={<Register />} />
        {/* 会员路由 - 需member角色 */}
        <Route element={<ProtectedRoute role="member" />}>
          <Route path="/member/*" element={<MemberDashboard />} />
        </Route>
        {/* 管理员路由 - 需admin角色 */}
        <Route element={<ProtectedRoute role="admin" />}>
          <Route path="/admin/*" element={<AdminDashboard />} />
        </Route>
        {/* 默认路由重定向到登录页 */}
        <Route path="/" element={<Login />} />
      </Routes>
    </div>
  );
}

export default App;
```

### 3.2 应用入口 (main.tsx)
```typescript
import React from 'react';
import ReactDOM from 'react-dom/client';
import { BrowserRouter } from 'react-router-dom';
import { AuthProvider } from './context/AuthContext';
import App from './App';
import './index.css';

// 渲染应用，包含路由和认证上下文
ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <BrowserRouter>
      <AuthProvider>
        <App />
      </AuthProvider>
    </BrowserRouter>
  </React.StrictMode>,
);
```

## 四、核心页面组件
### 4.1 登录页面 (Login.tsx)
```typescript
import React, { useState } from 'react';
import { useNavigate, Link } from 'react-router-dom';
import { supabase } from '../lib/supabase';
import { useAuth } from '../context/AuthContext';

// 登录页面组件
const Login: React.FC = () => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();
  const { signIn } = useAuth();

  // 登录表单提交处理
  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError(null);
    try {
      // 调用登录方法
      await signIn(email, password);
      // 根据角色跳转
      const { data } = await supabase.from('profiles').select('role').eq('email', email).single();
      navigate(data?.role === 'admin' ? '/admin' : '/member');
    } catch (err: any) {
      setError(err.message || '登录失败');
    } finally {
      setLoading(false);
    }
  };

  // 渲染登录表单
  return (
    <div className="flex min-h-screen items-center justify-center bg-gray-50 px-4 py-12">
      <div className="w-full max-w-md space-y-8 bg-white p-8 rounded-xl shadow-lg">
        <div className="text-center">
          <h2 className="text-3xl font-extrabold text-gray-900">广西自动化学会</h2>
          <p className="mt-2 text-sm text-gray-600">会员管理系统</p>
        </div>
        <form className="mt-8 space-y-6" onSubmit={handleLogin}>
          {error && <div className="p-3 text-red-700 bg-red-100 rounded-md text-sm">{error}</div>}
          {/* 邮箱输入 */}
          <div>
            <label htmlFor="email" className="block text-sm font-medium text-gray-700">邮箱</label>
            <div className="mt-1">
              <input type="email" id="email" required className="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="your@email.com" value={email} onChange={(e) => setEmail(e.target.value)} />
            </div>
          </div>
          {/* 密码输入 */}
          <div>
            <label htmlFor="password" className="block text-sm font-medium text-gray-700">密码</label>
            <div className="mt-1">
              <input type="password" id="password" required className="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="••••••••" value={password} onChange={(e) => setPassword(e.target.value)} />
            </div>
          </div>
          {/* 记住我和忘记密码 */}
          <div className="flex items-center justify-between">
            <div className="flex items-center">
              <input type="checkbox" id="remember-me" className="h-4 w-4 text-indigo-600" />
              <label htmlFor="remember-me" className="ml-2 text-sm text-gray-900">记住我</label>
            </div>
            <Link to="/forgot-password" className="text-sm text-indigo-600 hover:text-indigo-500">忘记密码？</Link>
          </div>
          {/* 登录按钮 */}
          <div>
            <button type="submit" disabled={loading} className="w-full py-2 px-4 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 disabled:opacity-50">
              {loading ? '登录中...' : '登录'}
            </button>
          </div>
          {/* 注册链接 */}
          <div className="text-center text-sm">
            <Link to="/register" className="text-indigo-600 hover:text-indigo-500">没有账号？立即注册</Link>
          </div>
        </form>
      </div>
    </div>
  );
};

export default Login;
```

## 五、管理员功能模块
### 5.1 管理员仪表盘核心 (AdminDashboard.tsx - 关键部分)
```typescript
import React, { useEffect, useState } from 'react';
import { Routes, Route, Link, useNavigate, useLocation } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';
import { supabase } from '../lib/supabase';
import type { Profile, Application } from '../types';
import * as XLSX from 'xlsx';
import { LogOut, Download, Edit, Check, X, Menu } from 'lucide-react';

// 会员列表组件
const MemberList: React.FC = () => {
  const [members, setMembers] = useState<Profile[]>([]);
  const [loading, setLoading] = useState(true);
  const [editingId, setEditingId] = useState<string | null>(null);
  const [editForm, setEditForm] = useState<Partial<Profile>>({});
  const [showHistory, setShowHistory] = useState(false);
  const [selectedMember, setSelectedMember] = useState<Profile | null>(null);

  // 加载会员数据
  useEffect(() => {
    fetchMembers();
  }, []);

  // 获取会员列表
  const fetchMembers = async () => {
    const { data, error } = await supabase.from('profiles').select('*').order('created_at', { ascending: false });
    if (error) console.error(error);
    else setMembers(data || []);
    setLoading(false);
  };

  // 导出会员数据到Excel
  const handleExport = () => {
    const data = members.map(m => ({
      "姓名": m.full_name,
      "邮箱": m.email,
      "角色": m.role === 'admin' ? '管理员' : '会员',
      "等级": m.membership_level,
      "状态": m.membership_status,
      "剩余天数": m.membership_duration_days,
      "电话": m.phone,
      "单位": m.institution,
      "加入日期": m.join_date
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Members");
    XLSX.writeFile(wb, "members_list.xlsx");
  };

  // 开始编辑会员
  const startEdit = (member: Profile) => {
    setEditingId(member.id);
    setEditForm({ membership_level: member.membership_level, role: member.role, membership_duration_days: member.membership_duration_days || 0 });
  };

  // 保存会员编辑
  const saveEdit = async (id: string) => {
    try {
      const { error } = await supabase.from('profiles').update(editForm).eq('id', id);
      if (error) throw error;
      setMembers(members.map(m => m.id === id ? { ...m, ...editForm } : m));
      setEditingId(null);
    } catch (err) {
      console.error(err);
      alert('更新失败');
    }
  };

  // 查看会员历史数据
  const viewMemberHistory = (member: Profile) => {
    setSelectedMember(member);
    setShowHistory(true);
  };

  // 渲染会员列表
  if (loading) return <div className="text-center py-10">加载中...</div>;
  
  return (
    <div className="bg-white shadow sm:rounded-lg">
      {/* 会员列表头部 */}
      <div className="flex justify-between items-center px-6 py-4">
        <h3 className="text-lg font-medium text-gray-900">会员列表</h3>
        <button onClick={handleExport} className="flex items-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
          <Download className="mr-2 h-4 w-4" /> 导出Excel
        </button>
      </div>
      {/* 会员表格 */}
      <div className="overflow-x-auto">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">姓名/邮箱</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">单位/电话</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">等级/角色</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">状态</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">剩余天数</th>
              <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">操作</th>
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {members.map((member) => (
              <tr key={member.id}>
                <td className="px-6 py-4 whitespace-nowrap">
                  <div>{member.full_name}</div>
                  <div className="text-sm text-gray-500">{member.email}</div>
                </td>
                <td className="px-6 py-4 whitespace-nowrap">
                  <div>{member.institution || '-'}</div>
                  <div className="text-sm text-gray-500">{member.phone}</div>
                </td>
                <td className="px-6 py-4 whitespace-nowrap">
                  {editingId === member.id ? (
                    <div className="space-y-1">
                      <select className="text-sm border rounded" value={editForm.membership_level} onChange={e => setEditForm({...editForm, membership_level: e.target.value})}>
                        <option value="General">普通会员</option>
                        <option value="Student">学生会员</option>
                        <option value="Director">理事</option>
                        <option value="Chairman">理事长</option>
                        <option value="Vice Chairman">副理事长</option>
                        <option value="Secretary">秘书长</option>
                      </select>
                      <select className="text-sm border rounded" value={editForm.role} onChange={e => setEditForm({...editForm, role: e.target.value as 'admin' | 'member'})}>
                        <option value="member">会员</option>
                        <option value="admin">管理员</option>
                      </select>
                    </div>
                  ) : (
                    <>
                      <div>{member.membership_level}</div>
                      <div className="text-xs text-gray-500">{member.role === 'admin' ? '管理员' : '会员'}</div>
                    </>
                  )}
                </td>
                <td className="px-6 py-4 whitespace-nowrap">
                  <span className={`px-2 py-1 rounded-full text-xs font-semibold ${member.membership_status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}`}>
                    {member.membership_status === 'active' ? '正常' : member.membership_status === 'pending' ? '待审核' : '已拒绝'}
                  </span>
                </td>
                <td className="px-6 py-4 whitespace-nowrap">
                  {editingId === member.id ? (
                    <input type="number" min="0" className="text-sm border rounded" value={editForm.membership_duration_days} onChange={e => setEditForm({...editForm, membership_duration_days: parseInt(e.target.value) || 0})} />
                  ) : (
                    <div>{member.membership_duration_days || 0} 天</div>
                  )}
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-right">
                  {editingId === member.id ? (
                    <div className="flex gap-2 justify-end">
                      <button onClick={() => saveEdit(member.id)} className="text-green-600 hover:text-green-900"><Check className="h-5 w-5"/></button>
                      <button onClick={() => setEditingId(null)} className="text-red-600 hover:text-red-900"><X className="h-5 w-5"/></button>
                    </div>
                  ) : (
                    <div className="flex gap-3 justify-end">
                      <button onClick={() => startEdit(member)} className="text-indigo-600 hover:text-indigo-900"><Edit className="h-5 w-5"/></button>
                      <button onClick={() => viewMemberHistory(member)} className="text-blue-600 hover:text-blue-900">历史数据</button>
                    </div>
                  )}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      {/* 历史数据弹窗 */}
      {showHistory && selectedMember && (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 z-50 overflow-y-auto">
          <div className="relative top-20 mx-auto p-5 border w-4/5 max-w-4xl bg-white rounded-lg shadow-lg">
            <div className="flex justify-between items-center mb-6">
              <h3 className="text-xl font-semibold">{selectedMember.full_name} 的历年数据</h3>
              <button onClick={() => setShowHistory(false)} className="text-gray-400 hover:text-gray-600"><X className="h-6 w-6" /></button>
            </div>
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">年份</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">会员等级</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">状态</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">会员时长</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">缴费情况</th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {/* 模拟历史数据 */}
                  {[2024, 2023, 2022].map(year => (
                    <tr key={year}>
                      <td className="px-6 py-4 whitespace-nowrap">{year}</td>
                      <td className="px-6 py-4 whitespace-nowrap">普通会员</td>
                      <td className="px-6 py-4 whitespace-nowrap"><span className="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">正常</span></td>
                      <td className="px-6 py-4 whitespace-nowrap">365 天</td>
                      <td className="px-6 py-4 whitespace-nowrap">已支付</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            <div className="flex justify-end mt-6">
              <button onClick={() => setShowHistory(false)} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">关闭</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// 申请列表组件
const ApplicationList: React.FC = () => {
  const [applications, setApplications] = useState<Application[]>([]);

  // 加载申请数据
  useEffect(() => {
    fetchApplications();
  }, []);

  // 获取申请列表
  const fetchApplications = async () => {
    const { data, error } = await supabase.from('applications').select('*').order('created_at', { ascending: false });
    if (error) console.error(error);
    else setApplications(data || []);
  };

  // 更新申请状态
  const updateStatus = async (id: string, status: 'approved' | 'rejected') => {
    // 获取申请详情
    const { data: appData } = await supabase.from('applications').select('user_id').eq('id', id).single();
    if (!appData?.user_id) return;
    // 更新申请状态
    await supabase.from('applications').update({ status }).eq('id', id);
    setApplications(applications.map(a => a.id === id ? { ...a, status } : a));
    // 更新会员状态
    if (status === 'approved') {
      await supabase.from('profiles').update({ membership_status: 'active', membership_duration_days: 365 }).eq('id', appData.user_id);
      window.location.reload();
    }
  };

  // 渲染申请列表
  return (
    <div className="bg-white shadow sm:rounded-lg">
      <div className="px-4 py-5 sm:px-6">
        <h3 className="text-lg font-medium text-gray-900">入会申请列表</h3>
      </div>
      <ul className="divide-y divide-gray-200">
        {applications.map((app) => (
          <li key={app.id} className="px-4 py-4 sm:px-6">
            <div className="flex items-center justify-between">
              <div className="flex flex-col">
                <p className="text-sm font-medium text-indigo-600 truncate">{app.full_name}</p>
                <p className="text-sm text-gray-500">{app.content}</p>
                <p className="text-xs text-gray-400">{new Date(app.created_at).toLocaleDateString()}</p>
              </div>
              <div className="flex items-center gap-2">
                {app.status === 'pending' ? (
                  <>
                    <button onClick={() => updateStatus(app.id, 'approved')} className="px-3 py-1 bg-green-600 text-white text-xs rounded-full hover:bg-green-700">批准</button>
                    <button onClick={() => updateStatus(app.id, 'rejected')} className="px-3 py-1 bg-red-600 text-white text-xs rounded-full hover:bg-red-700">拒绝</button>
                  </>
                ) : (
                  <span className={`px-3 py-1 text-xs font-semibold rounded-full ${app.status === 'approved' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                    {app.status === 'approved' ? '已批准' : '已拒绝'}
                  </span>
                )}
              </div>
            </div>
          </li>
        ))}
        {applications.length === 0 && <li className="px-4 py-8 text-center text-gray-500">暂无申请记录</li>}
      </ul>
    </div>
  );
};

// 管理员仪表盘主组件
const AdminDashboard: React.FC = () => {
  const { signOut } = useAuth();
  const navigate = useNavigate();
  const location = useLocation();
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

  // 退出登录
  const handleSignOut = async () => {
    await signOut();
    navigate('/login');
  };

  // 路由激活状态
  const isActive = (path: string) => location.pathname.startsWith(path);

  // 导航链接样式
  const linkClass = (path: string) => `inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium ${isActive(path) ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700'}`;

  // 渲染管理员仪表盘
  return (
    <div className="min-h-screen bg-gray-50">
      {/* 导航栏 */}
      <nav className="bg-white shadow-sm sticky top-0 z-50">
        <div className="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
          <div className="flex h-16 justify-between">
            <div className="flex">
              <div className="flex flex-shrink-0 items-center">
                <span className="font-bold text-xl text-indigo-600">管理后台</span>
              </div>
              {/* 桌面端导航 */}
              <div className="hidden sm:ml-6 sm:flex sm:space-x-8">
                <Link to="/admin" className={linkClass('/admin')}>会员列表</Link>
                <Link to="/admin/applications" className={linkClass('/admin/applications')}>申请审核</Link>
              </div>
            </div>
            {/* 退出按钮 */}
            <div className="hidden sm:flex sm:items-center">
              <button onClick={handleSignOut} className="px-3 py-2 bg-white text-gray-900 rounded-md hover:bg-gray-50 border border-gray-300">
                <LogOut className="h-5 w-5 mr-1" /> 退出登录
              </button>
            </div>
            {/* 移动端菜单按钮 */}
            <div className="-mr-2 flex items-center sm:hidden">
              <button onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)} className="p-2 rounded-md text-gray-400 hover:bg-gray-100">
                {isMobileMenuOpen ? <X className="h-6 w-6" /> : <Menu className="h-6 w-6" />}
              </button>
            </div>
          </div>
        </div>
        {/* 移动端菜单 */}
        {isMobileMenuOpen && (
          <div className="sm:hidden bg-white border-t">
            <div className="space-y-1 pt-2 pb-3">
              <Link to="/admin" className="block px-3 py-2 border-l-4 text-base font-medium" onClick={() => setIsMobileMenuOpen(false)}>会员列表</Link>
              <Link to="/admin/applications" className="block px-3 py-2 border-l-4 text-base font-medium" onClick={() => setIsMobileMenuOpen(false)}>申请审核</Link>
            </div>
            <div className="border-t pt-4 pb-4">
              <button onClick={handleSignOut} className="flex w-full items-center gap-2 px-4 py-2 bg-red-50 text-red-700 rounded-md hover:bg-red-100">
                <LogOut className="h-5 w-5" /> 退出登录
              </button>
            </div>
          </div>
        )}
      </nav>
      {/* 页面内容 */}
      <div className="py-6 sm:py-10">
        <header className="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
          <h1 className="text-3xl font-bold text-gray-900">管理员仪表盘</h1>
        </header>
        <main className="mx-auto max-w-7xl sm:px-6 lg:px-8 mt-8">
          <Routes>
            <Route index element={<MemberList />} />
            <Route path="applications" element={<ApplicationList />} />
          </Routes>
        </main>
      </div>
    </div>
  );
};

export default AdminDashboard;
```

## 六、数据库脚本
### 6.1 核心表结构 (db_schema.sql)
```sql
-- 用户配置文件表
create table if not exists public.profiles (
  id uuid references auth.users on delete cascade not null primary key,
  email text unique not null,
  full_name text,
  role text check (role in ('member', 'admin')) default 'member',
  membership_level text default 'General',
  membership_status text default 'pending', -- pending, active, inactive
  membership_duration_days INTEGER default 0, -- 会员剩余天数
  payment_status text default 'unpaid',
  join_date date default current_date,
  phone text,
  institution text,
  created_at timestamptz default now()
);
-- 启用行级安全性
alter table public.profiles enable row level security;

-- 创建会员申请表
create table if not exists public.applications (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references public.profiles(id) on delete cascade not null,
  full_name text,
  content jsonb,
  status text default 'pending',
  created_at timestamptz default now()
);
-- 启用行级安全性
alter table public.applications enable row level security;

-- 创建消息表
create table if not exists public.messages (
  id uuid default gen_random_uuid() primary key,
  sender_id uuid references public.profiles(id) not null,
  receiver_id uuid references public.profiles(id) not null,
  subject text,
  content text,
  message_type text default 'text',
  related_entity_id uuid,
  is_read boolean default false,
  created_at timestamptz default now()
);
-- 启用行级安全性
alter table public.messages enable row level security;
```

### 6.2 邮件通知触发器 (db_email_notification.sql)
```sql
-- 添加邮件通知功能，新消息时发送邮件
create extension if not exists pg_net with schema extensions;

-- 发送新消息邮件函数
create or replace function public.send_new_message_email()
returns trigger
language plpgsql
security definer
as $$
begin
  -- 获取收件人信息
  select email, full_name into @recipient_email, @recipient_name
  from public.profiles where id = new.receiver_id;

  -- 获取发件人姓名
  select full_name into @sender_name from public.profiles where id = new.sender_id;

  -- 构建邮件内容
  @subject := '您收到了新消息 - 广西自动化学会';
  @html_content := '<!DOCTYPE html><html><body><div style="max-width: 600px; margin: 20px auto; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1);"><div style="background-color: #4f46e5; color: white; padding: 15px; border-radius: 8px 8px 0 0; text-align: center;"><h2>新消息通知</h2></div><div style="padding: 20px;"><p>您好，' || @recipient_name || '：</p><p>您收到了一条来自 <strong>' || @sender_name || '</strong> 的新消息：</p><h3>主题：' || new.subject || '</h3><p>' || new.content || '</p><p>请登录系统查看完整消息：</p><p><a href="https://auto-association-example.netlify.app" style="display: inline-block; background-color: #4f46e5; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; margin: 10px 0;">登录系统</a></p></div></div></body></html>';

  -- 调用Supabase Email API发送邮件
  perform extensions.http_post(
    url := 'https://aawgprtzvgiigtnvnipw.supabase.co/functions/v1/send-email',
    body := jsonb_build_object(
      'to', @recipient_email,
      'subject', @subject,
      'html', @html_content
    ),
    headers := jsonb_build_object(
      'Content-Type', 'application/json',
      'Authorization', 'Bearer ' || current_setting('supabase.functions.api_key')
    )
  );

  return new;
end;
$$;

-- 创建触发器，新消息时触发邮件发送
drop trigger if exists on_new_message on public.messages;
create trigger on_new_message after insert on public.messages for each row execute procedure public.send_new_message_email();
```

# 源代码整理完成
## 代码特点
1. **精简核心**：保留系统最关键功能代码
2. **分类清晰**：按模块组织，便于查阅
3. **注释简洁**：关键功能添加简要说明
4. **结构紧凑**：移除多余空白行，保持代码整洁
5. **功能完整**：涵盖认证、管理、申请、邮件等核心功能

## 使用说明
- 适用于快速了解系统核心架构和功能
- 可直接用于项目开发参考
- 结合完整文档使用效果更佳
