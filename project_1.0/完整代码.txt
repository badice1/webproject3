============================== src/lib/supabase.ts ==============================
// 导入Supabase客户端创建函数
import { createClient } from '@supabase/supabase-js';

// 从环境变量中获取Supabase URL和匿名密钥
// VITE_前缀是Vite环境变量的约定，确保它们能被客户端代码访问
const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

// 部署问题的调试日志
// 记录Supabase配置状态，用于调试部署问题
console.log('Supabase Configuration Check:', {
  urlConfigured: !!supabaseUrl, // URL是否已配置
  urlLength: supabaseUrl?.length, // URL长度
  urlStart: supabaseUrl?.substring(0, 8), // 只记录URL的前8个字符（https://），确保安全
  keyConfigured: !!supabaseAnonKey, // 密钥是否已配置
  keyLength: supabaseAnonKey?.length // 密钥长度
});

// 检查Supabase URL和密钥是否缺失
if (!supabaseUrl || !supabaseAnonKey) {
  console.error('CRITICAL ERROR: Missing Supabase URL or Anon Key. Please check your .env file or GitHub Secrets.');
}

// 创建并导出Supabase客户端实例
// 如果环境变量缺失，使用占位符防止立即崩溃，但API调用会失败
// 这样设计是为了在开发和部署过程中提供更好的错误信息
// 而不是让应用直接崩溃
// supabaseUrl: Supabase项目的URL
// supabaseAnonKey: Supabase项目的匿名密钥，用于客户端访问
// 这个客户端实例将用于所有与Supabase的交互，包括认证、数据库操作等
export const supabase = createClient(
  supabaseUrl || 'https://placeholder.supabase.co', 
  supabaseAnonKey || 'placeholder'
);

============================== src/types/index.ts ==============================
export interface Profile {
  id: string;
  email: string;
  full_name: string;
  role: 'member' | 'admin';
  membership_level?: string;
  membership_status?: 'active' | 'inactive' | 'pending';
  payment_status?: string;
  join_date?: string;
  phone?: string;
  institution?: string; // For "Student" or work place
  created_at: string;
}

export interface Application {
  id: string;
  user_id: string;
  full_name: string;
  content: string; // Could be JSON string
  status: 'pending' | 'approved' | 'rejected';
  created_at: string;
}

export interface AppMessage {
  id: string;
  sender_id: string;
  receiver_id: string;
  subject: string;
  content: string;
  message_type: 'text' | 'event_application';
  related_entity_id?: string;
  is_read: boolean;
  created_at: string;
  sender?: Profile; // Joined
  receiver?: Profile; // Joined
}

export interface AppEvent {
  id: string;
  creator_id: string;
  title: string;
  description: string;
  location: string;
  event_time: string;
  max_participants: number;
  created_at: string;
  creator?: Profile; // Joined
  participant_count?: number; // Calculated or joined
}

export interface EventParticipant {
  id: string;
  event_id: string;
  user_id: string;
  status: 'pending' | 'approved' | 'rejected';
  created_at: string;
  user?: Profile; // Joined
}

============================== src/context/AuthContext.tsx ==============================
// 导入React核心和相关钩子
import React, { createContext, useContext, useEffect, useState } from 'react';
// 导入Supabase的User和Session类型
import type { User, Session } from '@supabase/supabase-js';
// 导入Supabase客户端实例
import { supabase } from '../lib/supabase';
// 导入自定义的Profile类型
import type { Profile } from '../types';

/**
 * 认证上下文的类型定义
 * 包含用户信息、会话、个人资料、加载状态、管理员标识和登出方法
 */
interface AuthContextType {
  user: User | null; // 用户对象，未登录时为null
  session: Session | null; // 会话对象，包含认证信息
  profile: Profile | null; // 用户个人资料，从profiles表获取
  loading: boolean; // 加载状态，用于控制UI显示
  isAdmin: boolean; // 是否为管理员角色
  signOut: () => Promise<void>; // 登出方法
}

/**
 * 创建认证上下文
 * 设置默认值，用于未提供Provider时的 fallback
 */
const AuthContext = createContext<AuthContextType>({
  user: null,
  session: null,
  profile: null,
  loading: true,
  isAdmin: false,
  signOut: async () => {}, // 默认空函数
});

/**
 * 自定义Hook，用于在组件中访问认证上下文
 * @returns 认证上下文对象
 */
export const useAuth = () => useContext(AuthContext);

/**
 * 认证上下文提供者组件
 * 负责管理用户状态、会话和个人资料
 * @param children - 子组件，将共享认证上下文
 */
export const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  // 用户状态
  const [user, setUser] = useState<User | null>(null);
  // 会话状态
  const [session, setSession] = useState<Session | null>(null);
  // 个人资料状态
  const [profile, setProfile] = useState<Profile | null>(null);
  // 加载状态
  const [loading, setLoading] = useState(true);

  // 初始化和监听认证状态变化
  useEffect(() => {
    // 1. 获取初始会话
    supabase.auth.getSession().then(({ data: { session } }) => {
      // 设置会话和用户状态
      setSession(session);
      setUser(session?.user ?? null);
      
      // 如果用户已登录，获取个人资料
      if (session?.user) {
        fetchProfile(session.user.id);
      } else {
        // 未登录，结束加载状态
        setLoading(false);
      }
    }).catch(err => {
      // 处理获取会话失败的情况
      console.error("Failed to get session:", err);
      setLoading(false);
    });

    // 2. 监听认证状态变化
    const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
      // 更新会话和用户状态
      setSession(session);
      setUser(session?.user ?? null);
      
      // 如果用户已登录，获取个人资料
      if (session?.user) {
        fetchProfile(session.user.id);
      } else {
        // 未登录，清除个人资料，结束加载状态
        setProfile(null);
        setLoading(false);
      }
    });

    // 3. 组件卸载时取消订阅
    return () => subscription.unsubscribe();
  }, []); // 空依赖数组，只在组件挂载时执行一次

  /**
   * 获取用户个人资料
   * @param userId - 用户ID
   * @param retries - 重试次数，默认为3次
   */
  const fetchProfile = async (userId: string, retries = 3) => {
    try {
      // 从profiles表中查询用户资料
      const { data, error } = await supabase
        .from('profiles') // 指定表名
        .select('*') // 查询所有字段
        .eq('id', userId) // 按ID筛选
        .single(); // 只返回一条记录

      if (error) {
        // PGRST116错误表示没有找到记录（可能profile尚未创建）
        if (error.code === 'PGRST116' && retries > 0) {
          // 记录重试信息
          console.log(`Profile not found, retrying... (${retries} attempts left)`);
          // 延迟1秒后重试，减少服务器压力
          setTimeout(() => fetchProfile(userId, retries - 1), 1000);
          return; // 不结束加载状态，继续等待
        }
        // 其他错误或重试次数用完，记录错误并结束加载
        console.error('Error fetching profile:', error);
        setLoading(false);
      } else {
        // 成功获取资料，更新状态并结束加载
        setProfile(data);
        setLoading(false);
      }
    } catch (err) {
      // 处理意外错误
      console.error('Unexpected error fetching profile:', err);
      setLoading(false);
    }
  };

  /**
   * 登出方法
   * 调用Supabase的signOut方法，并清除本地状态
   */
  const signOut = async () => {
    await supabase.auth.signOut(); // 调用Supabase登出API
    // 清除本地状态
    setProfile(null);
    setUser(null);
    setSession(null);
  };

  /**
   * 计算是否为管理员
   * 根据profile的role字段判断
   */
  const isAdmin = profile?.role === 'admin';

  return (
    // 提供认证上下文给子组件
    <AuthContext.Provider value={{ user, session, profile, loading, isAdmin, signOut }}>
      {children}
    </AuthContext.Provider>
  );
};

============================== src/App.tsx ==============================
// 导入React Router的核心组件，用于定义路由
import { Routes, Route } from 'react-router-dom';

// 导入所有页面组件
import Login from './pages/Login'; // 登录页面
import Register from './pages/Register'; // 注册页面
import ForgotPassword from './pages/ForgotPassword'; // 忘记密码页面
import ResetPassword from './pages/ResetPassword'; // 重置密码页面
import MemberDashboard from './pages/MemberDashboard'; // 会员仪表盘
import AdminDashboard from './pages/AdminDashboard'; // 管理员仪表盘
import ProtectedRoute from './components/ProtectedRoute'; // 路由保护组件

/**
 * 应用的根组件，定义了所有路由配置
 * 负责将不同的URL路径映射到对应的页面组件
 */
function App() {
  return (
    // 应用的根容器，设置最小高度和背景色
    <div className="min-h-screen bg-gray-50">
      {/* 路由配置容器 */}
      <Routes>
        {/* 公开路由 - 无需登录即可访问 */}
        <Route path="/login" element={<Login />} /> {/* 登录页面路由 */}
        <Route path="/register" element={<Register />} /> {/* 注册页面路由 */}
        <Route path="/forgot-password" element={<ForgotPassword />} /> {/* 忘记密码页面路由 */}
        <Route path="/reset-password" element={<ResetPassword />} /> {/* 重置密码页面路由 */}
        
        {/* 受保护路由 - 只有会员可以访问 */}
        <Route 
          element={<ProtectedRoute role="member" />} // 使用ProtectedRoute组件保护，指定角色为member
        >
          {/* 会员仪表盘路由，使用通配符*允许子路由 */}
          <Route path="/member/*" element={<MemberDashboard />} />
        </Route>

        {/* 受保护路由 - 只有管理员可以访问 */}
        <Route 
          element={<ProtectedRoute role="admin" />} // 使用ProtectedRoute组件保护，指定角色为admin
        >
          {/* 管理员仪表盘路由，使用通配符*允许子路由 */}
          <Route path="/admin/*" element={<AdminDashboard />} />
        </Route>

        {/* 默认路由 - 访问根路径时重定向到登录页面 */}
        <Route path="/" element={<Login />} />
      </Routes>
    </div>
  );
}

// 导出App组件，作为应用的根组件
export default App;

============================== src/components/ProtectedRoute.tsx ==============================
// 导入React核心
import React from 'react';
// 导入路由相关组件：Navigate用于重定向，Outlet用于渲染子路由
import { Navigate, Outlet } from 'react-router-dom';
// 导入自定义的useAuth钩子，用于获取用户认证状态
import { useAuth } from '../context/AuthContext';

/**
 * ProtectedRoute组件的属性接口
 * @property role - 可选，指定允许访问的角色，可以是'member'或'admin'
 */
interface ProtectedRouteProps {
  role?: 'member' | 'admin';
}

/**
 * 路由保护组件，用于控制页面访问权限
 * 根据用户的登录状态和角色来决定是否允许访问受保护的路由
 * @param props - 组件属性，包含可选的role
 * @returns 允许访问时渲染子路由，否则重定向到相应页面
 */
const ProtectedRoute: React.FC<ProtectedRouteProps> = ({ role }) => {
  // 使用useAuth钩子获取用户状态：user(用户对象)、profile(用户资料)、loading(加载状态)
  const { user, profile, loading } = useAuth();

  // 如果用户信息正在加载中，显示加载提示
  if (loading) {
    return <div className="flex justify-center items-center h-screen">Loading...</div>;
  }

  // 如果用户未登录，重定向到登录页面
  // replace属性表示替换当前历史记录，而不是添加新的记录
  if (!user) {
    return <Navigate to="/login" replace />;
  }

  // 如果指定了角色，并且获取到了用户profile，进行角色验证
  if (role && profile) {
    // 如果需要管理员角色，但用户不是管理员，重定向到会员页面
    if (role === 'admin' && profile.role !== 'admin') {
       return <Navigate to="/member" replace />;
    }
    // 注意：如果角色是member，所有登录用户都可以访问，因为admin角色也属于member权限范围
  }

  // 如果所有条件都满足，渲染子路由（通过Outlet组件）
  return <Outlet />;
};

// 导出ProtectedRoute组件，供其他文件使用
export default ProtectedRoute;

============================== src/main.tsx ==============================
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import App from './App.tsx'
import './index.css'
import { HashRouter } from 'react-router-dom'
import { AuthProvider } from './context/AuthContext.tsx'

createRoot(document.getElementById('root')!).render(
  <StrictMode>
    <HashRouter>
      <AuthProvider>
        <App />
      </AuthProvider>
    </HashRouter>
  </StrictMode>,
)

============================== src/pages/Login.tsx ==============================
// 导入React核心和useState钩子
import React, { useState } from 'react';

// 导入路由相关钩子和组件：useNavigate用于页面跳转，Link用于导航链接
import { useNavigate, Link } from 'react-router-dom';
// 导入Supabase客户端实例，用于登录认证
import { supabase } from '../lib/supabase';

/**
 * 登录页面组件
 * 提供会员和管理员的登录功能
 * 包含邮箱密码输入、表单验证、登录逻辑和错误处理
 */
const Login: React.FC = () => {
  // 邮箱状态
  const [email, setEmail] = useState('');
  // 密码状态
  const [password, setPassword] = useState('');
  // 加载状态，用于控制登录按钮的禁用和文本显示
  const [loading, setLoading] = useState(false);
  // 错误信息状态，用于显示登录失败的原因
  const [error, setError] = useState<string | null>(null);
  // 导航钩子，用于登录成功后的页面跳转
  const navigate = useNavigate();

  /**
   * 登录表单提交处理函数
   * @param e - 表单提交事件
   */
  const handleLogin = async (e: React.FormEvent) => {
    // 阻止表单默认提交行为
    e.preventDefault();
    // 设置加载状态为true
    setLoading(true);
    // 清除之前的错误信息
    setError(null);

    try {
      // 调用Supabase的signInWithPassword方法进行登录
      const { data, error } = await supabase.auth.signInWithPassword({
        email, // 邮箱地址
        password, // 密码
      });

      // 如果登录失败，抛出错误
      if (error) throw error;

      // 登录成功后，手动获取用户角色，用于快速跳转到对应页面
      // 这里没有依赖AuthContext的profile，因为profile可能不会立即加载
      if (data.user) {
         // 从profiles表中查询用户角色
         const { data: profileData } = await supabase
          .from('profiles') // 指定表名
          .select('role') // 只查询role字段，提高查询效率
          .eq('id', data.user.id) // 按用户ID筛选
          .single(); // 只返回一条记录
         
         // 根据用户角色跳转到对应页面
         if (profileData?.role === 'admin') {
           navigate('/admin'); // 管理员跳转到管理员仪表盘
         } else {
           navigate('/member'); // 普通会员跳转到会员仪表盘
         }
      }
    } catch (err: any) {
      // 处理登录错误
      console.error("Login failed:", err);
      // 根据错误类型显示不同的错误信息
      if (err.message === 'Failed to fetch') {
        setError('连接服务器失败。请检查您的网络连接，或确认系统维护状态。');
      } else {
        setError(err.message || '登录发生错误');
      }
    } finally {
      // 无论登录成功还是失败，都设置加载状态为false
      setLoading(false);
    }
  };

  // 渲染登录页面UI
  return (
    // 页面根容器，设置全屏高度、背景色和居中布局
    <div className="flex min-h-screen items-center justify-center bg-gray-50 px-4 py-12 sm:px-6 lg:px-8">
      {/* 登录表单容器 */}
      <div className="w-full max-w-md space-y-8 bg-white p-8 rounded-xl shadow-lg">
        {/* 标题区域 */}
        <div>
          {/* 主标题 */}
          <h2 className="mt-2 text-center text-3xl font-extrabold tracking-tight text-gray-900">
            广西自动化学会
          </h2>
          {/* 副标题 */}
          <p className="mt-2 text-center text-sm text-gray-600">
            会员管理系统
          </p>
        </div>
        
        {/* 登录表单 */}
        <form className="mt-8 space-y-6" onSubmit={handleLogin}>
          {/* 表单输入区域 */}
          <div className="space-y-4">
            {/* 邮箱输入字段 */}
            <div>
              <label 
                htmlFor="email" 
                className="block text-sm font-medium text-gray-700"
              >
                电子邮箱
              </label>
              <div className="mt-1">
                <input
                  id="email"
                  name="email"
                  type="email"
                  autoComplete="email"
                  required
                  className="block w-full rounded-md border-0 py-2 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6 px-3"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                />
              </div>
            </div>

            {/* 密码输入字段 */}
            <div>
              <label 
                htmlFor="password" 
                className="block text-sm font-medium text-gray-700"
              >
                密码
              </label>
              <div className="mt-1">
                <input
                  id="password"
                  name="password"
                  type="password"
                  autoComplete="current-password"
                  required
                  className="block w-full rounded-md border-0 py-2 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6 px-3"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                />
              </div>
            </div>
          </div>

          {/* 错误信息显示 */}
          {error && (
            <div className="rounded-md bg-red-50 p-4">
              <div className="flex">
                <div className="ml-3">
                  <h3 className="text-sm font-medium text-red-800">{error}</h3>
                </div>
              </div>
            </div>
          )}

          {/* 登录按钮 */}
          <div>
            <button
              type="submit"
              disabled={loading} // 加载状态下禁用按钮
              className="flex w-full justify-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 disabled:opacity-50 transition-colors duration-200"
            >
              {/* 根据加载状态显示不同的文本 */}
              {loading ? '登录中...' : '登录'}
            </button>
          </div>
          
          {/* 注册和忘记密码链接 */}
          <div className="flex items-center justify-between text-sm">
            {/* 注册链接 */}
            <Link 
              to="/register" 
              className="font-medium text-indigo-600 hover:text-indigo-500 transition-colors"
            >
              还没有账号？去注册
            </Link>
            {/* 忘记密码链接 */}
            <Link 
              to="/forgot-password" 
              className="font-medium text-indigo-600 hover:text-indigo-500 transition-colors"
            >
              忘记密码？
            </Link>
          </div>

        </form>
      </div>
    </div>
  );
};

// 导出Login组件
export default Login;

