# 广西自动化学会会员管理系统 - 关键源代码整理

## 一、核心配置文件

### 1.1 Supabase配置 (supabase.ts)
```typescript
// Supabase客户端配置，用于连接Supabase数据库和认证服务
import { createClient } from '@supabase/supabase-js';

// 从环境变量获取Supabase URL和密钥
const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

// 创建并导出Supabase客户端实例
export const supabase = createClient(supabaseUrl, supabaseAnonKey);
```

### 1.2 类型定义 (types/index.ts)
```typescript
// 用户配置文件接口
export interface Profile {
  id: string;
  email: string;
  full_name: string;
  role: 'member' | 'admin';
  membership_level?: string;
  membership_status?: 'active' | 'inactive' | 'pending';
  membership_duration_days?: number; // 会员剩余时长（天）
  payment_status?: string;
  join_date?: string;
  phone?: string;
  institution?: string; // 单位/学校
  created_at: string;
}

// 会员申请接口
export interface Application {
  id: string;
  user_id: string;
  full_name: string;
  content: string; // 申请内容
  status: 'pending' | 'approved' | 'rejected';
  created_at: string;
}

// 消息接口
export interface AppMessage {
  id: string;
  sender_id: string;
  receiver_id: string;
  subject: string;
  content: string;
  message_type: 'text' | 'event_application';
  related_entity_id?: string;
  is_read: boolean;
  created_at: string;
  sender?: Profile; // 关联发件人信息
  receiver?: Profile; // 关联收件人信息
}

// 活动接口
export interface AppEvent {
  id: string;
  creator_id: string;
  title: string;
  description: string;
  location: string;
  event_time: string;
  max_participants: number;
  created_at: string;
  creator?: Profile;
  participant_count?: number;
}

// 活动参与者接口
export interface EventParticipant {
  id: string;
  event_id: string;
  user_id: string;
  status: 'pending' | 'approved' | 'rejected';
  created_at: string;
  user?: Profile;
}
```

## 二、认证与授权

### 2.1 认证上下文 (AuthContext.tsx)
```typescript
import React, { createContext, useContext, useState, useEffect } from 'react';
import { supabase } from '../lib/supabase';
import type { Session, User } from '@supabase/supabase-js';
import type { Profile } from '../types';

// 认证上下文类型定义
interface AuthContextType {
  user: User | null;
  session: Session | null;
  profile: Profile | null;
  loading: boolean;
  signIn: (email: string, password: string) => Promise<void>;
  signUp: (email: string, password: string, fullName: string) => Promise<void>;
  signOut: () => Promise<void>;
  resetPassword: (email: string) => Promise<void>;
  updatePassword: (password: string) => Promise<void>;
}

// 创建认证上下文
const AuthContext = createContext<AuthContextType | undefined>(undefined);

// 认证提供者组件
export const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [user, setUser] = useState<User | null>(null);
  const [session, setSession] = useState<Session | null>(null);
  const [profile, setProfile] = useState<Profile | null>(null);
  const [loading, setLoading] = useState(true);

  // 初始化认证状态
  useEffect(() => {
    // 获取当前会话
    const { data: { session } } = supabase.auth.getSession();
    setSession(session);
    setUser(session?.user ?? null);

    // 监听认证状态变化
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      async (_event, session) => {
        setSession(session);
        setUser(session?.user ?? null);
        
        // 获取用户配置文件
        if (session?.user) {
          const { data } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', session.user.id)
            .single();
          setProfile(data || null);
        } else {
          setProfile(null);
        }
        setLoading(false);
      }
    );

    return () => subscription.unsubscribe();
  }, []);

  // 登录方法
  const signIn = async (email: string, password: string) => {
    await supabase.auth.signInWithPassword({ email, password });
  };

  // 注册方法
  const signUp = async (email: string, password: string, fullName: string) => {
    await supabase.auth.signUp({
      email,
      password,
      options: {
        data: { full_name: fullName }
      }
    });
  };

  // 退出登录方法
  const signOut = async () => {
    await supabase.auth.signOut();
  };

  // 重置密码方法
  const resetPassword = async (email: string) => {
    await supabase.auth.resetPasswordForEmail(email);
  };

  // 更新密码方法
  const updatePassword = async (password: string) => {
    await supabase.auth.updateUser({ password });
  };

  // 提供认证上下文值
  const value = {
    user,
    session,
    profile,
    loading,
    signIn,
    signUp,
    signOut,
    resetPassword,
    updatePassword
  };

  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
};

// 自定义Hook，用于访问认证上下文
export const useAuth = () => {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};
```

### 2.2 路由保护组件 (ProtectedRoute.tsx)
```typescript
import React from 'react';
import { Navigate, Outlet, useLocation } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';

// 路由保护组件，根据角色限制访问
interface ProtectedRouteProps {
  role?: 'member' | 'admin'; // 可选的角色要求
}

const ProtectedRoute: React.FC<ProtectedRouteProps> = ({ role }) => {
  const { user, profile, loading } = useAuth();
  const location = useLocation();

  // 加载状态显示
  if (loading) {
    return <div className="flex justify-center items-center h-screen">加载中...</div>;
  }

  // 未登录用户重定向到登录页
  if (!user) {
    return <Navigate to="/login" state={{ from: location }} replace />;
  }

  // 检查角色要求
  if (role && profile?.role !== role) {
    // 根据用户角色重定向到相应的仪表盘
    return profile?.role === 'admin' 
      ? <Navigate to="/admin" replace /> 
      : <Navigate to="/member" replace />;
  }

  // 允许访问，渲染子路由
  return <Outlet />;
};

export default ProtectedRoute;
```

## 三、路由配置与应用入口

### 3.1 应用路由配置 (App.tsx)
```typescript
// 导入React Router核心组件
import { Routes, Route } from 'react-router-dom';

// 导入所有页面组件
import Login from './pages/Login';
import Register from './pages/Register';
import ForgotPassword from './pages/ForgotPassword';
import ResetPassword from './pages/ResetPassword';
import MemberDashboard from './pages/MemberDashboard';
import AdminDashboard from './pages/AdminDashboard';
import ProtectedRoute from './components/ProtectedRoute';

// 应用根组件，定义所有路由配置
function App() {
  return (
    <div className="min-h-screen bg-gray-50">
      <Routes>
        {/* 公开路由 - 无需登录 */}
        <Route path="/login" element={<Login />} />
        <Route path="/register" element={<Register />} />
        <Route path="/forgot-password" element={<ForgotPassword />} />
        <Route path="/reset-password" element={<ResetPassword />} />
        
        {/* 受保护路由 - 会员访问 */}
        <Route element={<ProtectedRoute role="member" />}>
          <Route path="/member/*" element={<MemberDashboard />} />
        </Route>

        {/* 受保护路由 - 管理员访问 */}
        <Route element={<ProtectedRoute role="admin" />}>
          <Route path="/admin/*" element={<AdminDashboard />} />
        </Route>

        {/* 默认路由 - 重定向到登录页 */}
        <Route path="/" element={<Login />} />
      </Routes>
    </div>
  );
}

export default App;
```

### 3.2 应用入口文件 (main.tsx)
```typescript
import React from 'react';
import ReactDOM from 'react-dom/client';
import { BrowserRouter } from 'react-router-dom';
import { AuthProvider } from './context/AuthContext';
import App from './App';
import './index.css';

// 渲染应用，包含路由和认证上下文
ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <BrowserRouter>
      <AuthProvider>
        <App />
      </AuthProvider>
    </BrowserRouter>
  </React.StrictMode>,
);
```

## 四、核心页面组件

### 4.1 登录页面 (Login.tsx)
```typescript
import React, { useState } from 'react';
import { useNavigate, Link } from 'react-router-dom';
import { supabase } from '../lib/supabase';
import { useAuth } from '../context/AuthContext';

// 登录页面组件
const Login: React.FC = () => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();
  const { signIn } = useAuth();

  // 登录表单提交处理
  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError(null);

    try {
      // 调用登录方法
      await signIn(email, password);
      
      // 登录成功后，获取用户角色并跳转
      const { data } = await supabase
        .from('profiles')
        .select('role')
        .eq('email', email)
        .single();
      
      // 根据角色跳转到相应仪表盘
      if (data?.role === 'admin') {
        navigate('/admin');
      } else {
        navigate('/member');
      }
    } catch (err: any) {
      // 处理登录错误
      if (err.message === 'Failed to fetch') {
        setError('连接服务器失败，请检查网络连接');
      } else {
        setError(err.message || '登录发生错误');
      }
    } finally {
      setLoading(false);
    }
  };

  // 渲染登录页面
  return (
    <div className="flex min-h-screen items-center justify-center bg-gray-50 px-4 py-12 sm:px-6 lg:px-8">
      <div className="w-full max-w-md space-y-8 bg-white p-8 rounded-xl shadow-lg">
        <div>
          <h2 className="mt-2 text-center text-3xl font-extrabold tracking-tight text-gray-900">广西自动化学会</h2>
          <p className="mt-2 text-center text-sm text-gray-600">会员管理系统</p>
        </div>
        
        <form className="mt-8 space-y-6" onSubmit={handleLogin}>
          {error && (
            <div className="p-3 text-red-700 bg-red-100 rounded-md text-sm">{error}</div>
          )}
          
          <div>
            <label htmlFor="email" className="block text-sm font-medium text-gray-700">邮箱</label>
            <div className="mt-1">
              <input
                id="email"
                name="email"
                type="email"
                autoComplete="email"
                required
                className="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                placeholder="your@email.com"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
              />
            </div>
          </div>
          
          <div>
            <label htmlFor="password" className="block text-sm font-medium text-gray-700">密码</label>
            <div className="mt-1">
              <input
                id="password"
                name="password"
                type="password"
                autoComplete="current-password"
                required
                className="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                placeholder="••••••••"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
              />
            </div>
          </div>
          
          <div className="flex items-center justify-between">
            <div className="flex items-center">
              <input
                id="remember-me" type="checkbox" className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
              />
              <label htmlFor="remember-me" className="ml-2 block text-sm text-gray-900">记住我</label>
            </div>
            <div className="text-sm">
              <Link to="/forgot-password" className="font-medium text-indigo-600 hover:text-indigo-500">忘记密码？</Link>
            </div>
          </div>
          
          <div>
            <button
              type="submit"
              disabled={loading}
              className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {loading ? '登录中...' : '登录'}
            </button>
          </div>
          
          <div className="text-center text-sm">
            <Link to="/register" className="font-medium text-indigo-600 hover:text-indigo-500">没有账号？立即注册</Link>
          </div>
        </form>
      </div>
    </div>
  );
};

export default Login;
```

## 五、管理员功能模块

### 5.1 管理员仪表盘核心功能 (AdminDashboard.tsx - 关键部分)
```typescript
import React, { useEffect, useState } from 'react';
import { Routes, Route, Link, useNavigate, useLocation } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';
import { supabase } from '../lib/supabase';
import type { Profile, Application } from '../types';
import * as XLSX from 'xlsx';
import { LogOut, Download, Mail, Edit, Check, X, Menu } from 'lucide-react';
import MessageCenter from './MessageCenter';

// 会员列表组件
const MemberList: React.FC = () => {
  const [members, setMembers] = useState<Profile[]>([]);
  const [loading, setLoading] = useState(true);
  const [editingId, setEditingId] = useState<string | null>(null);
  const [editForm, setEditForm] = useState<Partial<Profile>>({});
  
  // 会员历史数据状态
  const [showHistoryModal, setShowHistoryModal] = useState(false);
  const [selectedMember, setSelectedMember] = useState<Profile | null>(null);
  const [memberHistory, setMemberHistory] = useState<any[]>([]);
  const [historyLoading, setHistoryLoading] = useState(false);

  // 初始化加载会员数据
  useEffect(() => {
    fetchMembers();
  }, []);

  // 获取会员列表
  const fetchMembers = async () => {
    const { data, error } = await supabase
      .from('profiles')
      .select('*')
      .order('created_at', { ascending: false });
    
    if (error) console.error(error);
    else setMembers(data || []);
    setLoading(false);
  };

  // 导出会员列表到Excel
  const handleExport = () => {
    const dataToExport = members.map(m => ({
      "姓名": m.full_name,
      "邮箱": m.email,
      "角色": m.role === 'admin' ? '管理员' : '会员',
      "会员等级": m.membership_level,
      "状态": m.membership_status,
      "剩余时长": m.membership_duration_days,
      "电话": m.phone,
      "单位": m.institution,
      "加入时间": m.join_date
    }));
    
    const ws = XLSX.utils.json_to_sheet(dataToExport);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Members");
    XLSX.writeFile(wb, "members_list.xlsx");
  };

  // 开始编辑会员信息
  const startEdit = (member: Profile) => {
    setEditingId(member.id);
    setEditForm({ 
      membership_level: member.membership_level, 
      role: member.role,
      membership_duration_days: member.membership_duration_days || 0
    });
  };

  // 保存会员编辑
  const saveEdit = async (id: string) => {
    try {
      const { error } = await supabase
        .from('profiles')
        .update(editForm)
        .eq('id', id);
      
      if (error) throw error;
      
      setMembers(members.map(m => m.id === id ? { ...m, ...editForm } : m));
      setEditingId(null);
    } catch (err) {
      console.error(err);
      alert('更新会员失败');
    }
  };

  // 查看会员历年数据
  const viewMemberHistory = async (memberId: string) => {
    const member = members.find(m => m.id === memberId);
    if (!member) return;
    
    setSelectedMember(member);
    setShowHistoryModal(true);
    setHistoryLoading(true);
    
    try {
      // 模拟会员历史数据
      const mockHistory = [
        { year: 2024, level: "普通会员", status: "active", duration_days: 365, payment: "已支付" },
        { year: 2023, level: "普通会员", status: "active", duration_days: 365, payment: "已支付" },
        { year: 2022, level: "学生会员", status: "active", duration_days: 365, payment: "已支付" }
      ];
      
      setMemberHistory(mockHistory);
    } catch (error) {
      console.error("Failed to fetch member history:", error);
    } finally {
      setHistoryLoading(false);
    }
  };

  // 发送邮件给会员
  const sendEmail = (email: string) => {
    window.location.href = `mailto:${email}?subject=通知&body=请查看门户网站上的最新通知。`;
  };

  // 会员列表渲染...
  return (
    <div className="bg-white shadow sm:rounded-lg">
      {/* 会员列表内容... */}
      {/* 包含会员表格、编辑功能、历史数据查看等 */}
    </div>
  );
};

// 申请列表组件
const ApplicationList: React.FC = () => {
  const [applications, setApplications] = useState<Application[]>([]);
  
  // 初始化加载申请数据
  useEffect(() => {
    fetchApplications();
  }, []);

  // 获取申请列表
  const fetchApplications = async () => {
    const { data, error } = await supabase
      .from('applications')
      .select('*')
      .order('created_at', { ascending: false });
    
    if (error) console.error(error);
    else setApplications(data || []);
  };

  // 更新申请状态
  const updateStatus = async (id: string, status: 'approved' | 'rejected') => {
    // 1. 获取申请详情
    const { data: applicationData, error: fetchError } = await supabase
      .from('applications')
      .select('user_id')
      .eq('id', id)
      .single();
    
    if (fetchError) {
      console.error('Failed to fetch application:', fetchError);
      return;
    }
    
    // 2. 更新申请状态
    const { error: updateAppError } = await supabase
      .from('applications')
      .update({ status })
      .eq('id', id);
    
    if (updateAppError) {
      console.error('Failed to update application status:', updateAppError);
      return;
    }
    
    // 3. 根据申请状态更新会员状态
    if (applicationData.user_id) {
      if (status === 'approved') {
        // 批准申请：设置会员状态为active，并给予默认365天会员时长
        const { error: updateMemberError } = await supabase
          .from('profiles')
          .update({ 
            membership_status: 'active',
            membership_duration_days: 365 // 默认给予1年会员时长
          })
          .eq('id', applicationData.user_id);
        
        if (updateMemberError) {
          console.error('Failed to update member status:', updateMemberError);
        }
      } else if (status === 'rejected') {
        // 拒绝申请：设置会员状态为rejected
        const { error: updateMemberError } = await supabase
          .from('profiles')
          .update({ membership_status: 'rejected' })
          .eq('id', applicationData.user_id);
        
        if (updateMemberError) {
          console.error('Failed to update member status:', updateMemberError);
        }
      }
    }
    
    // 4. 更新本地状态
    setApplications(applications.map(a => a.id === id ? { ...a, status } : a));
    
    // 5. 如果批准，刷新页面确保会员列表显示最新状态
    if (status === 'approved') {
      window.location.reload();
    }
  };

  // 申请列表渲染...
  return (
    <div className="bg-white shadow sm:rounded-lg">
      {/* 申请列表内容... */}
      {/* 包含申请审核、状态更新等功能 */}
    </div>
  );
};

// 管理员仪表盘主组件
const AdminDashboard: React.FC = () => {
  const { signOut } = useAuth();
  const navigate = useNavigate();
  const location = useLocation();
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

  // 退出登录处理
  const handleSignOut = async () => {
    await signOut();
    navigate('/login');
  };

  // 路由激活状态判断
  const isActive = (path: string) => {
    if (path === '/admin') {
      return location.pathname === '/admin' || location.pathname === '/admin/';
    }
    return location.pathname.startsWith(path);
  };

  // 导航链接样式
  const linkClass = (path: string) => 
    `inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium transition-colors duration-200 ${isActive(path) ? 'border-indigo-500 text-gray-900' : 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700'}`;

  // 移动端导航链接样式
  const mobileLinkClass = (path: string) =>
    `block pl-3 pr-4 py-2 border-l-4 text-base font-medium transition-colors duration-200 ${isActive(path) ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-transparent text-gray-500 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-700'}`;

  // 管理员仪表盘渲染...
  return (
    <div className="min-h-screen bg-gray-50">
      {/* 导航栏 */}
      <nav className="bg-white shadow-sm sticky top-0 z-50">
        <div className="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
          <div className="flex h-16 justify-between">
            <div className="flex">
              <div className="flex flex-shrink-0 items-center">
                <span className="font-bold text-xl text-indigo-600 tracking-tight">管理后台</span>
              </div>
              {/* 桌面端导航菜单 */}
              <div className="hidden sm:ml-6 sm:flex sm:space-x-8">
                <Link to="/admin" className={linkClass('/admin')}>会员列表</Link>
                <Link to="/admin/applications" className={linkClass('/admin/applications')}>申请审核</Link>
                <Link to="/admin/messages" className={linkClass('/admin/messages')}>消息中心</Link>
              </div>
            </div>
            {/* 退出登录按钮 */}
            <div className="hidden sm:flex sm:items-center">
              <button
                onClick={handleSignOut}
                className="relative inline-flex items-center gap-x-1.5 rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 transition-colors"
              >
                <LogOut className="-ml-0.5 h-5 w-5 text-gray-400" aria-hidden="true" />
                退出登录
              </button>
            </div>
            {/* 移动端菜单按钮 */}
            <div className="-mr-2 flex items-center sm:hidden">
              <button
                onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}
                className="inline-flex items-center justify-center rounded-md p-2 text-gray-400 hover:bg-gray-100 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500"
              >
                <span className="sr-only">打开菜单</span>
                {isMobileMenuOpen ? <X className="block h-6 w-6" aria-hidden="true" /> : <Menu className="block h-6 w-6" aria-hidden="true" />}
              </button>
            </div>
          </div>
        </div>
        
        {/* 移动端导航菜单 */}
        {isMobileMenuOpen && (
          <div className="sm:hidden bg-white border-t border-gray-200">
            <div className="space-y-1 pt-2 pb-3">
              <Link to="/admin" className={mobileLinkClass('/admin')} onClick={() => setIsMobileMenuOpen(false)}>会员列表</Link>
              <Link to="/admin/applications" className={mobileLinkClass('/admin/applications')} onClick={() => setIsMobileMenuOpen(false)}>申请审核</Link>
              <Link to="/admin/messages" className={mobileLinkClass('/admin/messages')} onClick={() => setIsMobileMenuOpen(false)}>消息中心</Link>
            </div>
            {/* 移动端退出登录按钮 */}
            <div className="border-t border-gray-200 pt-4 pb-4">
              <div className="flex items-center px-4">
                <button
                  onClick={handleSignOut}
                  className="flex w-full items-center gap-x-2 rounded-md bg-red-50 px-3 py-2 text-base font-medium text-red-700 hover:bg-red-100"
                >
                  <LogOut className="h-5 w-5" />
                  退出登录
                </button>
              </div>
            </div>
          </div>
        )}
      </nav>

      {/* 页面内容 */}
      <div className="py-6 sm:py-10">
        <header>
          <div className="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
            <h1 className="text-3xl font-bold leading-tight tracking-tight text-gray-900">管理员仪表盘</h1>
          </div>
        </header>
        <main>
          <div className="mx-auto max-w-7xl sm:px-6 lg:px-8 mt-8">
            <Routes>
               <Route index element={<MemberList />} />
               <Route path="applications" element={<ApplicationList />} />
               <Route path="messages" element={<MessageCenter />} />
            </Routes>
          </div>
        </main>
      </div>
    </div>
  );
};

export default AdminDashboard;
```

## 六、消息中心模块

### 6.1 消息中心核心功能 (MessageCenter.tsx - 关键部分)
```typescript
import React, { useEffect, useState } from 'react';
import { supabase } from '../lib/supabase';
import { useAuth } from '../context/AuthContext';
import type { AppMessage, Profile } from '../types';
import { Mail, Send } from 'lucide-react';

const MessageCenter: React.FC = () => {
  const { user } = useAuth();
  const [activeTab, setActiveTab] = useState<'inbox' | 'sent' | 'compose' | 'members'>('inbox');
  const [messages, setMessages] = useState<AppMessage[]>([]);
  const [loading, setLoading] = useState(false);
  const [members, setMembers] = useState<Profile[]>([]);
  
  // 写信表单状态
  const [recipientEmail, setRecipientEmail] = useState('');
  const [subject, setSubject] = useState('');
  const [content, setContent] = useState('');
  const [sending, setSending] = useState(false);

  // 根据当前标签加载数据
  useEffect(() => {
    if (activeTab === 'inbox' || activeTab === 'sent') {
      fetchMessages();
    } else if (activeTab === 'members') {
      fetchMembers();
    }
  }, [activeTab]);

  // 获取消息列表
  const fetchMessages = async () => {
    setLoading(true);
    try {
      let query = supabase
        .from('messages')
        .select(`*, sender:sender_id (email, full_name), receiver:receiver_id (email, full_name)`)
        .order('created_at', { ascending: false });

      if (activeTab === 'inbox') {
        query = query.eq('receiver_id', user?.id);
      } else {
        query = query.eq('sender_id', user?.id);
      }

      const { data, error } = await query;
      if (error) throw error;
      setMessages(data || []);
    } catch (err) {
      console.error('Error fetching messages:', err);
    } finally {
      setLoading(false);
    }
  };

  // 获取通讯录成员
  const fetchMembers = async () => {
    setLoading(true);
    try {
      const { data, error } = await supabase
        .from('profiles')
        .select('*')
        .order('full_name');
      
      if (error) throw error;
      setMembers(data || []);
    } catch (err) {
      console.error('Error fetching members:', err);
    } finally {
      setLoading(false);
    }
  };

  // 发送消息
  const handleSendMessage = async (e: React.FormEvent) => {
    e.preventDefault();
    setSending(true);
    try {
      // 1. 查找收件人
      const { data: recipients, error: recipientError } = await supabase
        .from('profiles')
        .select('id')
        .eq('email', recipientEmail)
        .single();

      if (recipientError || !recipients) {
        alert('未找到该邮箱对应的用户');
        setSending(false);
        return;
      }

      // 2. 发送消息
      const { error: sendError } = await supabase
        .from('messages')
        .insert([
          {
            sender_id: user?.id,
            receiver_id: recipients.id,
            subject,
            content,
            message_type: 'text'
          }
        ]);

      if (sendError) throw sendError;

      alert('消息发送成功');
      setRecipientEmail('');
      setSubject('');
      setContent('');
      setActiveTab('sent');
    } catch (err: any) {
      alert('发送失败: ' + err.message);
    } finally {
      setSending(false);
    }
  };

  // 消息中心渲染...
  return (
    <div className="bg-white shadow sm:rounded-lg min-h-[600px] flex flex-col">
      {/* 消息中心内容 */}
      {/* 包含收件箱、发件箱、写信功能、通讯录等 */}
    </div>
  );
};

export default MessageCenter;
```

## 七、数据库脚本

### 7.1 数据库表结构 (db_schema.sql - 关键部分)
```sql
-- 创建用户配置文件表
create table if not exists public.profiles (
  id uuid references auth.users on delete cascade not null primary key,
  email text unique not null,
  full_name text,
  role text check (role in ('member', 'admin')) default 'member',
  membership_level text default 'General',
  membership_status text default 'pending', -- pending, active, inactive
  membership_duration_days INTEGER default 0, -- 会员剩余天数
  payment_status text default 'unpaid',
  join_date date default current_date,
  phone text,
  institution text,
  created_at timestamptz default now()
);

-- 启用行级安全性
alter table public.profiles enable row level security;

-- 创建会员申请表
create table if not exists public.applications (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references public.profiles(id) on delete cascade not null,
  full_name text,
  content jsonb,
  status text default 'pending',
  created_at timestamptz default now()
);

-- 启用行级安全性
alter table public.applications enable row level security;

-- 创建消息表
create table if not exists public.messages (
  id uuid default gen_random_uuid() primary key,
  sender_id uuid references public.profiles(id) not null,
  receiver_id uuid references public.profiles(id) not null,
  subject text,
  content text,
  message_type text default 'text', -- 'text', 'event_application'
  related_entity_id uuid, -- 关联的ID
  is_read boolean default false,
  created_at timestamptz default now()
);

-- 启用行级安全性
alter table public.messages enable row level security;

-- 创建活动表
create table if not exists public.events (
  id uuid default gen_random_uuid() primary key,
  creator_id uuid references public.profiles(id) not null,
  title text not null,
  description text,
  location text,
  event_time timestamptz not null,
  max_participants int default 0,
  created_at timestamptz default now()
);

-- 启用行级安全性
alter table public.events enable row level security;

-- 创建活动参与者表
create table if not exists public.event_participants (
  id uuid default gen_random_uuid() primary key,
  event_id uuid references public.events(id) on delete cascade not null,
  user_id uuid references public.profiles(id) not null,
  status text default 'pending', -- pending, approved, rejected
  created_at timestamptz default now(),
  unique(event_id, user_id)
);

-- 启用行级安全性
alter table public.event_participants enable row level security;
```

### 7.2 邮件通知触发器 (db_email_notification.sql - 关键部分)
```sql
-- 添加邮件通知功能：当新消息插入时发送邮件给收件人

-- 确保 pg_net 扩展已启用
create extension if not exists pg_net with schema extensions;

-- 创建发送新消息通知邮件的函数
create or replace function public.send_new_message_email()
returns trigger
language plpgsql
security definer set search_path = public
as $$
begin
  -- 获取收件人的邮箱和姓名
  select email, full_name into @recipient_email, @recipient_name
  from public.profiles
  where id = new.receiver_id;

  -- 获取发件人的姓名
  select full_name into @sender_name
  from public.profiles
  where id = new.sender_id;

  -- 构建邮件内容
  @subject := '您收到了新消息 - 广西自动化学会';
  @html_content := '<!DOCTYPE html>...邮件HTML模板...';

  -- 调用 Supabase Email API 发送邮件
  perform extensions.http_post(
    url := 'https://aawgprtzvgiigtnvnipw.supabase.co/functions/v1/send-email',
    body := jsonb_build_object(
      'to', @recipient_email,
      'subject', @subject,
      'html', @html_content
    ),
    headers := jsonb_build_object(
      'Content-Type', 'application/json',
      'Authorization', 'Bearer ' || current_setting('supabase.functions.api_key')
    )
  );

  return new;
end;
$$;

-- 创建触发器，在新消息插入后触发邮件发送
drop trigger if exists on_new_message on public.messages;
create trigger on_new_message after insert on public.messages for each row execute procedure public.send_new_message_email();
```

# 源代码整理完成

## 代码特点
1. **模块化设计**：按功能模块分类，便于维护和扩展
2. **完整的类型定义**：使用TypeScript确保类型安全
3. **清晰的注释**：关键代码添加了详细注释
4. **响应式布局**：适配不同屏幕尺寸
5. **完整的功能实现**：包含认证、授权、消息、管理等核心功能
6. **数据库脚本**：包含表结构和触发器定义

## 使用说明
1. 该代码是广西自动化学会会员管理系统的核心源代码
2. 按模块组织，可直接用于项目开发和学习参考
3. 结合项目报告和其他文档使用，效果更佳
4. 如需运行项目，请参考README.md中的部署指南
